<%=render "testing-start"%>
<div class="testing w-100 d-flex flex-column align-items-center">
    <%= render partial: "testing-top", locals: { testing: 'second' }%>
    <div class="testing-second-top">
        <div class="testing-second-top-top">
            <h1>* 목표 설정 : 최대 3개  &nbsp;&nbsp;  * 타겟 설정 : 목표 당 최대 3개 &nbsp;&nbsp;   * 테스터 수 : 타겟 당 최대 5명<Br>
            추가 테스트 진행을 원하시면 별도 문의 부탁드립니다. &nbsp;(약간의 추가금액이 발생합니다.)</h1>
            <button>
            <h2>도움이 필요하신가요?</h2>
            </button>
        </div> 
        <form action="/testing/third" id="second-form" name="second-form" class="second-form">
            <input type="hidden" value="<%=params[:brandname]%>" name="[customer][brandname]">
            <input type="hidden" value="<%=params[:name]%>" name="[customer][name]">
            <input type="hidden" value="<%=params[:phonenumber]%>" name="[customer][phonenumber]">
            <input type="hidden" value="<%=params[:email]%>" name="[customer][email]">
            <input type="hidden" value="<%=params[:media]%>" name="[customer][media]">
            <input type="hidden" value="<%=params[:testtype]%>" name="[customer][testtype]">
            <input type="hidden" value="<%=params[:url]%>" name="[customer][url]">
            <%= render "second-box"%>
        
        </form>
    </div>
<div class="testing-second-bottom">
   <div class="testing-second-bottom-top">
        <button class="purpose-add">
            <h3>목표를 추가하고 싶으신가요?</h3>
        </button>
        <div class="testing-second-bottom-top-right first">
            <div class=" d-flex justify-content-between align-items-center w-100">
                <h1>목표 1. 리워드 </h1>
                <h2 class="reward-1">0P</h2>
            </div>
            <div class=" d-flex justify-content-between align-items-center w-100">
                <h1>목표 2. 리워드 </h1>
                <h2 class="reward-2">0P</h2>
            </div>
            <div class=" d-flex justify-content-between align-items-center w-100">
                <h1>목표 3. 리워드 </h1>
                <h2 class="reward-3">0P</h2>
            </div>
        </div>
    </div>
    <div class="testing-second-bottom-middle">
        <div class="testing-second-bottom-top-right">
            <div class="d-flex justify-content-between align-items-center w-100">
                <h1>테스트 비용 합계</h1>
                <h2 class="reward-sum">0P</h2>
            </div>
            <div class="d-flex justify-content-between align-items-center w-100">
                <h1>프로모션 할인 </h1>
                <h2 class="reward-discount">-0P</h2>
            </div>
        </div>
    </div>
    <div class="testing-second-bottom-bottom">
        <div class="w-100 d-flex flex-column align-items-end">
            <div class="testing-second-bottom-top-right">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <h1>결제 금액</h1>
                    <h2 class="reward-pay">0P</h2>
                </div>
            </div>
        </div>
        <button id="complete">완료하기</button>
    </div>
</div>
</div>

<!-- Modal -->
<div id="target-alert" class="ui modal">
  <div class="header">타겟 추가 제한</div>
  <div class="content">
    <p>한 목표당 3개의 타겟만 설정할 수 있습니다.</p>
  </div>
</div>
<div id="purpose-alert" class="ui modal">
  <div class="header">목표 추가 제한</div>
  <div class="content">
    <p>3개의 목표만 설정할 수 있습니다.</p>
  </div>
</div>

<div class="testing-third-loading second">
    <%=image_tag("preloader.svg")%>
</div>

<div class="testing-help-purpose">
    <div class="testing-help-purpose-box">
    
        <h1>추가 진행이 필요하신가요?</h1>
        <h2>아래 연락처로 별도 문의 주시면,<br>
        추가 테스트 진행을 도와드릴게요!</h1>
        <h3>추가비용이 발생할 수 있습니다.</h3>
        <div class="d-flex justify-content-center">
        <%=image_tag("popup-manager.svg")%>
        <%=image_tag("popup-manager2.svg")%>
        </div>
        <button>닫기</button>
    </div>
</div>


<script>
  
    $(".navbar-nav a:last-child()").addClass("color");
    $("#purpose-is").focus();
    $(document).on('click', '.purpose-add', function(){   
        var purpose_count = document.getElementsByClassName("accordion").length;
        if (purpose_count != 3 ) {
            $(".testing-third-loading").css({"display":"flex"});
            $.ajax ({
                url: "/testing/second1",
                method: "get",
                data: {"purpose_count" : purpose_count}
            });
        }
        else {
            $(".testing-help-purpose").css({"display":"block"});
        }
    });
    $(document).on('click', '.testing-help-purpose-box button', function(){  
        $(".testing-help-purpose").css({"display":"none"});
    })
    $(document).on('click', '.card-submit a', function(){   
        var a = $(this).parent().parent().parent().attr("id");
        var purpose_number = a.replace(/[^0-9]/g,"");
        var target_count = $(`#accordionExample${purpose_number} .card-body-2`).length;
        var purpose_count = document.getElementsByClassName("accordion").length;
        if (target_count != 3 ) {
            $(".testing-third-loading").css({"display":"flex"});
            $.ajax ({
                url: "/testing/second2",
                method: "get",
                data: {"target_count" : target_count, "purpose_number" : purpose_number, "purpose_count": purpose_count}
            });
        }
        else {
            alertify.alert()
            .setting({
                'frameless':false,
                'title':"타겟 추가 제한",
                'closableByDimmer':true,
                'closable': false,
                modal: false,
                transition:'pulse',
                'pinnable': false,
                message: '타겟은 한 목표당 최대 3개만 추가할 수 있습니다.',
                'label':'Ok'
            }).show();
        }
    });
 
    setInterval(function () {
        $.ajax({
            url: "/testing/second3",
            method: "get",
            data: {"purpose_count":$(".accordion").length}
        })

    }, 1000);

    $("#complete").click(function() {
        var toggle = true;
    $(".purpose-is").each(function(element) {
        var  subject =  $(this).parent().parent().parent().parent()
        var subject_target = subject.find(".card-body-2")
        var testernumber=0;
        if ($(this).val() == '') {
            alertify.alert()
            .setting({
                'frameless':false,
                'title':"목표 작성 오류",
                'closableByDimmer':true,
                'closable': false,
                modal: false,
                transition:'pulse',
                'pinnable': false,
                message: '목표는 필수 입력 사항입니다.',
                'label':'Ok'
            }).show();
            toggle = false; 
        }
        else if (Number(subject.find(".minute option:selected").val()) + Number(subject.find(".second option:selected").val()) == 0) {
            alertify.alert()
            .setting({
                'frameless':false,
                'title':"예상 시간 선택 오류",
                'closableByDimmer':true,
                'closable': false,
                modal: false,
                transition:'pulse',
                'pinnable': false,
                message: '예상 시간은 필수 선택 사항입니다.',
                'label':'Ok'
            }).show();
            toggle = false; 
            
        }
        else {
            subject_target.each(function(i,e) {
                testernumber += Number($(this).find(".testernumber option:selected").val());
            
                if  ($(this).find(".target").val() == '') {
                    alertify.alert()
                    .setting({
                        'frameless':false,
                        'title':"타겟명 작성 오류",
                        'closableByDimmer':true,
                        'closable': false,
                        modal: false,
                        transition:'pulse',
                        'pinnable': false,
                        message: '타겟명은 필수 작성 사항입니다.',
                        'label':'Ok'
                    }).show();
                    toggle = false; 
                }
                else  {
                    console.log(testernumber)
                    if (testernumber > 5 ) {
                        alertify.alert()
                        .setting({
                        'frameless':false,
                        'title': "테스터수 선택 오류",
                        'closableByDimmer':true,
                        'closable': false,
                        modal: false,
                        transition:'pulse',
                        'pinnable': false,
                        message: '테스터수는 목표당 최대 5명입니다.',
                        'label':'Ok'
                        }).show();
                        toggle = false; 
                    }
                }  
            })
            if  (testernumber == 0 ) {
                console.log(testernumber)
            
                    alertify.alert()
                    .setting({
                    'frameless':false,
                    'title': "테스터수 선택 오류",
                    'closableByDimmer':true,
                    'closable': false,
                    modal: false,
                    transition:'pulse',
                    'pinnable': false,
                    message: '테스터수는 필수 선택 사항입니다.',
                    'label':'Ok'
                    }).show();
                    toggle = false; 
                
            } 
                    
        }
    });
    if (toggle == true) {
        document.getElementById("second-form").submit();
    }    
    }); 
    

</script>


